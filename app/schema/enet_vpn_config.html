<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8" />
	<title>VPN Tunnels Configuration</title>
	<link rel='stylesheet' id='theme_stylesheet'>
	<link rel='stylesheet' id='icon_stylesheet'>
	<style>[class*="foundicon-"] {font-family: GeneralFoundicons;font-style: normal;}</style>
	<script src="jsoneditor.min.js"></script>
</head>

<body>
	<IMG SRC="ethernity_logo.png" ALT="Ethernity Networks Ltd.">
	<h1>VPN Tunnels Configuration</h1>
	<button id='apply'>Apply</button>
	<button id='apply_restart'>Apply & Restart VPN Service</button>
	<button id='apply_reboot'>Apply & Reboot VPN GW</button>
	<button id='reload'>Reload Saved Settings</button>
	<button id='shutdown'>Shutdown VPN GW</button>
	<span id='valid_indicator'></span>
	<div id='editor_holder'></div>
	<p id='status'>[]</p>
    
<script>

const config_mngr_port = 2766;
var enet_vpn_curr_cfg = { };
var enet_vpn_editor = undefined;

///////////////////////////////
function enet_vpn_config_post(json_cfg) {

	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			document.getElementById("status").innerHTML = '[' + this.responseText + ']';
		};
	};
	const config_mngr = 'http://' + window.location.hostname + ':' + config_mngr_port;
	const cmd_obj_str = JSON.stringify(json_cfg);
	xhttp.open('POST', config_mngr, true);
	xhttp.send(cmd_obj_str);
	console.log(config_mngr);
}
///////////////////////////////

///////////////////////////////
function enet_vpn_config_get() {

	var xhttp = new XMLHttpRequest();
	xhttp.onreadystatechange = function() {
		if(this.readyState == 4 && this.status == 200) {
			const enet_vpn_curr_cfg = JSON.parse(this.responseText);
			if(enet_vpn_editor === undefined) {
				enet_vpn_config_init(enet_vpn_curr_cfg.VPN);
			}
			else {
				enet_vpn_editor.setValue(enet_vpn_curr_cfg.VPN);
			};
		};
	};
	//const config_mngr = 'http://' + window.location.hostname + ':' + config_mngr_port + '/';
	const config_mngr = 'http://' + window.location.hostname + ':' + window.location.port + '/enet_vpn_config.json';
	xhttp.open('GET', config_mngr, true);
	xhttp.send();
};
///////////////////////////////  

///////////////////////////////  
function enet_vpn_config_init(json_cfg) {

	enet_vpn_editor = new JSONEditor(document.getElementById('editor_holder'), {

		ajax: true,
		compact: true,
		disable_edit_json: false,
		disable_properties: true,
		keep_oneof_values: false,
		show_errors: "always",

		schema: {
			$ref: "schema_enet_vpn.json",
		},

		startval: json_cfg,
		no_additional_properties: true,
		required_by_default: true
	});

	document.getElementById('apply').addEventListener('click', function() {

		const json_cfg_to_post = {
			UPDATE: 'apply',
			VPN: enet_vpn_editor.getValue()
		};
		enet_vpn_config_post(json_cfg_to_post);
	});
	
	document.getElementById('apply_restart').addEventListener('click', function() {

		const json_cfg_to_post = {
			UPDATE: 'apply_restart',
			VPN: enet_vpn_editor.getValue()
		};
		enet_vpn_config_post(json_cfg_to_post);
	});
	
	document.getElementById('apply_reboot').addEventListener('click', function() {

		const json_cfg_to_post = {
			UPDATE: 'apply_reboot',
			VPN: enet_vpn_editor.getValue()
		};
		enet_vpn_config_post(json_cfg_to_post);
	});
	
	document.getElementById('reload').addEventListener('click', function() {

		enet_vpn_config_get();
	});
	
	document.getElementById('shutdown').addEventListener('click', function() {

		const json_cfg_to_post = {
			UPDATE: 'shutdown'
		};
		enet_vpn_config_post(json_cfg_to_post);
	});

	enet_vpn_editor.on('change', function() {

		var errors = enet_vpn_editor.validate();
		document.getElementById("status").innerHTML = '[' + JSON.stringify(errors) + ']';
		var valid_indicator = document.getElementById('valid_indicator');

		if(errors.length) {
			valid_indicator.style.color = 'red';
			valid_indicator.textContent = "not valid";
		}
		else {
			valid_indicator.style.color = 'green';
			valid_indicator.textContent = "valid";
		};
	});
};
///////////////////////////////  

window.onload = function() {

	enet_vpn_config_get();
};

</script>
	
<script>
(function() {

	var setTheme = function(theme, no_reload) {
	
		theme = theme || '';

		var mapping = {
			barebones: '',
			html: '',
			bootstrap2: '//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css',
			bootstrap3: '//netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css',
			bootstrap4: '//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css',
			foundation3: '//cdnjs.cloudflare.com/ajax/libs/foundation/3.2.5/stylesheets/foundation.css',
			foundation4: '//cdnjs.cloudflare.com/ajax/libs/foundation/4.3.2/css/foundation.min.css',
			foundation5: '//cdnjs.cloudflare.com/ajax/libs/foundation/5.5.3/css/foundation.min.css',
			foundation6: '//cdnjs.cloudflare.com/ajax/libs/foundation/6.2.4/foundation.min.css',
			jqueryui: '//code.jquery.com/ui/1.10.3/themes/south-street/jquery-ui.css',
			materialize: '//cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css'
		};

		if(typeof mapping[theme] === 'undefined') {
			theme = 'bootstrap3';
		};

		var scriptMapping = {
			materialize: [
				'https://code.jquery.com/jquery-3.2.1.min.js',
				'https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js'
			]
		};

		var themeScripts = scriptMapping[theme],
			head = document.getElementsByTagName('head')[0],
			script;

		if (typeof themeScripts == 'string') { themeScripts = [themeScripts]; }
		if (Array.isArray(themeScripts)) {
			for (var i = 0; i < themeScripts.length; i++) {
				script = document.createElement('script');
				script.type = 'text/javascript';
				script.src = themeScripts[i];
				head.appendChild(script);
			};
		};

		JSONEditor.defaults.options.theme = theme;

		document.getElementById('theme_stylesheet').href = mapping[theme];

		if(!no_reload) reload(true);
	};
	
	var setIconlib = function(iconlib,no_reload) {
	
		iconlib = iconlib || '';
		var mapping = {
			foundation2: '//cdnjs.cloudflare.com/ajax/libs/foundicons/2.0/stylesheets/general_foundicons.css',
			foundation3: '//cdnjs.cloudflare.com/ajax/libs/foundicons/3.0.0/foundation-icons.css',
			fontawesome3: '//cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.css',
			fontawesome4: '//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css',
			fontawesome5: 'https://use.fontawesome.com/releases/v5.6.1/css/all.css',
			materialicons: 'https://fonts.googleapis.com/icon?family=Material+Icons'
		};

		JSONEditor.defaults.options.iconlib = iconlib;

		document.getElementById('icon_stylesheet').href = mapping[iconlib] || '';

		if(!no_reload) reload(true);
	};
	
	setTheme((window.location.href.match(/[?&]theme=([^&]+)/)||[])[1] || 'bootstrap2', true);
    setIconlib((window.location.href.match(/[?&]iconlib=([^&]*)/)||[null,'bootstrap3'])[1], true);
	JSONEditor.defaults.options.object_layout = (window.location.href.match(/[?&]object_layout=([^&]+)/)||[])[1] || 'normal';
	JSONEditor.defaults.options.show_errors = (window.location.href.match(/[?&]show_errors=([^&]+)/)||[])[1] || 'always';
})();
</script>
</body>
</html>
